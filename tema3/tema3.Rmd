---
title: "Titanic - Analiza prin clasificare supervizata"
output: html_notebook
---

## Load and process data
```{r}
library(rattle)
library(rpart.plot)
library(RColorBrewer)
library(e1071)
library(class)
library(randomForest)
library(xgboost)

train <- read.csv("../input_files/train.csv")
test <- read.csv("../input_files/test.csv")

#
full  <- bind_rows(train, test)

# Extract title from name
full$Title <- gsub('(.*, )|(\\..*)', '', full$Name)
rare_title <- c('Dona', 'Lady', 'the Countess','Capt', 'Col', 'Don', 
                'Dr', 'Major', 'Rev', 'Sir', 'Jonkheer')
full$Title[full$Title == 'Mlle']        <- 'Miss' 
full$Title[full$Title == 'Ms']          <- 'Miss'
full$Title[full$Title == 'Mme']         <- 'Mrs' 
full$Title[full$Title %in% rare_title]  <- 'Rare Title'

# Extract Surname from Name
full$Surname <- sapply(full$Name,  
                       function(x) strsplit(as.character(x), split = '[,.]')[[1]][1])

# Create a family size variable including the passenger themselves
full$Fsize <- full$SibSp + full$Parch + 1

# Create a family variable 
full$Family <- paste(full$Surname, full$Fsize, sep='_')

# Discretize family size
full$FsizeD[full$Fsize == 1] <- 'singleton'
full$FsizeD[full$Fsize < 5 & full$Fsize > 1] <- 'small'
full$FsizeD[full$Fsize > 4] <- 'large'

# Create a Deck variable. Get passenger deck A - F:
full$Deck<-factor(sapply(full$Cabin, function(x) strsplit(as.character(x), NULL)[[1]][1]))

full$Child[full$Age < 18] <- 'Child'
full$Child[full$Age >= 18] <- 'Adult'
full$Mother <- 'Not Mother'
full$Mother[full$Sex == 'female' & full$Parch > 0 & full$Age > 18 & full$Title != 'Miss'] <- 'Mother'

train <- full[1:891,]
test <- full[892:1309,]
#

# Remove Name, Ticket and Cabin columns
train <- train[,-c(4,9,11)]
test <- test[,-c(4,9,11)]

# Change Sex to 0 = male, 1 = female
train$Sex <- sapply(as.character(train$Sex), switch, 'male' = 0, 'female' = 1)
test$Sex <- sapply(as.character(test$Sex), switch, 'male' = 0, 'female' = 1)

# Change Embarked column to 0 = 'C', 1 = 'Q', 2 = 'S' and remove NAs
train$Embarked[train$Embarked == ''] <- 'S'
train$Embarked <- sapply(as.character(train$Embarked), switch, 'C' = 0, 'Q' = 1, 'S' = 2)
test$Embarked <- sapply(as.character(test$Embarked), switch, 'C' = 0, 'Q' = 1, 'S' = 2)

# Remove NAs from Age and Fare columns
train$Age[is.na(train$Age)] <- mean(train$Age,na.rm=T)
train$Fare[is.na(train$Fare)] <- mean(train$Fare,na.rm=T)
test$Age[is.na(test$Age)] <- mean(test$Age,na.rm=T)
test$Fare[is.na(test$Fare)] <- mean(test$Fare,na.rm=T)
```

## Arbori de decizie 1
```{r}
decision_tree <- rpart(Survived ~ Pclass + Sex + Age + SibSp + Parch + Fare + Embarked,
             data=train,
             method="class")
fancyRpartPlot(decision_tree)

decision_tree_prediction <- predict(decision_tree, newdata = test, type = "class",  control=rpart.control(minsplit=2, cp=0.005))
decision_tree_solution <- data.frame(PassengerId = test$PassengerId, Survived = decision_tree_prediction)
write.csv(decision_tree_solution, file="../tema3/solutions/decision_tree_solution.csv", row.names = FALSE)
```

## Arbori de decizie 2
```{r}
decision_tree <- rpart(Survived ~ Pclass + Sex + Fare + Embarked + Title + Child + Mother + Fsize,
             data=train,
             method="class")
fancyRpartPlot(decision_tree)

decision_tree_prediction <- predict(decision_tree, newdata = test, type = "class",  control=rpart.control(minsplit=3, cp=0.05))
decision_tree_solution <- data.frame(PassengerId = test$PassengerId, Survived = decision_tree_prediction)
write.csv(decision_tree_solution, file="../tema3/solutions/decision_tree_solution.csv", row.names = FALSE)
```


## Bayes naiv
```{r}
naive_bayes <- naiveBayes(Survived ~ Pclass + Sex + Age + SibSp + Parch + Fare + Embarked,
                       data=train,
                       method="class")
#str(naive_bayes)
summary(naive_bayes)

naive_bayes_prediction <- predict(decision_tree, newdata = test,  type = "class")
naive_bayes_solution <- data.frame(PassengerId = test$PassengerId, Survived = naive_bayes_prediction)
write.csv(naive_bayes_solution, file="../tema3/solutions/naive_bayes_solution.csv", row.names = FALSE)
```

## KNN
```{r}
knn <- knn(train[,-c(1,2)], test[,-1], train$Survived, k = 5,  l = 0, prob = FALSE, use.all = TRUE)
knn_solution <- data.frame(PassengerId = test$PassengerId, Survived = knn)
write.csv(knn_solution, file="../tema3/solutions/knn_solution.csv", row.names = FALSE)
```

## Random forest
```{r}
svm <- svm(as.factor(Survived) ~ Pclass + Sex + Age + SibSp + Parch + Fare + Embarked,
                              data=train, 
                              importance=TRUE, 
                              ntree=100)
random_forest

random_forest_prediction <- predict(random_forest, newdata = test,  type = "class")
random_forest_solution <- data.frame(PassengerId = test$PassengerId, Survived = random_forest_prediction)
write.csv(random_forest_solution, file="../tema3/solutions/random_forest_solution.csv", row.names = FALSE)
```

## xgBoost
```{r}
dtrain <- xgb.DMatrix(data =  as.matrix(train[,-c(1,2)]), label = train$Survived)
dtest <- xgb.DMatrix(data =  as.matrix(test[,-1]))
boost <- xgboost(data = dtrain, max.depth = 10, eta=1, nthread = 2, nround = 5, objective = "binary:logistic")

boost_prediction <- predict(boost, newdata = dtest,  type = "class")

boost_prediction <- as.numeric(boost_prediction > 0.5)
boost_solution <- data.frame(PassengerId = test$PassengerId, Survived = boost_prediction)
write.csv(boost_solution, file="../tema3/solutions/boost_solution.csv", row.names = FALSE)
```

## Neural network
```{r}
model <- model.matrix(~ Survived + Pclass + Sex+ Age + Fare + SibSp,data = train)
neural_network <- neuralnet( 
  Survived ~ Pclass + Sex+ Age + Fare + SibSp, data=model, hidden=2, threshold=0.01, linear.output = F)
plot(neural_network)

model_test <- model.matrix(~ Pclass + Sex+ Age + Fare + SibSp,data = test)
res <- neuralnet::compute(neural_network, model_test[,c("Pclass","Sex","Age", "Fare","SibSp")])
nn_prediction = round(res$net.result)

nn_solution <- data.frame(PassengerId = test$PassengerId, Survived = nn_prediction)
write.csv(nn_solution, file="../tema3/solutions/nn_solution.csv", row.names = FALSE)
```

## SVM
```{r}
svm <- svm(Survived ~ Pclass + Sex + Age + SibSp + Parch + Fare + Embarked,
             data=train,
             cost=100,
             gamma=1)

svm_prediction <- predict(svm, newdata = test)
svm_prediction <- as.numeric(svm_prediction > 0.5)
svm_solution <- data.frame(PassengerId = test$PassengerId, Survived = svm_prediction)
write.csv(svm_solution, file="../tema3/solutions/svm_solution.csv", row.names = FALSE)
```